<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Chat Overlay with 7TV</title>
    <style>
        :root {
            --chat-background: rgba(18, 18, 18, 0.8);
            --message-background: rgba(30, 30, 30, 0.6);
            --text-color: #ffffff;
            --default-name-color: #ff4081;
            --border-radius: 8px;
            --font-size: 16px;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --emote-size-multiplier: 1.75;
            --emote-size: calc(var(--font-size) * var(--emote-size-multiplier));
            --container-width: 100%;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-family);
            background: transparent;
            color: var(--text-color);
            font-size: var(--font-size);
            display: flex;
            flex-direction: column;
        }

        *,
        *:before,
        *:after {
            box-sizing: border-box;
        }

        #chat-container {
            flex: 1;
            margin: 0;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            -ms-overflow-style: none;
            scrollbar-width: none;
            background: var(--chat-background);
            height: calc(100vh - calc(var(--font-size) * 2));
            position: relative;
        }

        #chat-container::-webkit-scrollbar {
            display: none;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –±–ª–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .chat-message {
            position: relative;
            animation: slideIn 0.3s ease-out;
            opacity: 1;
            padding: 8px 12px;
            background: var(--message-background, #25252b);
            border-radius: var(--border-radius, 6px);
            animation: slideIn 0.3s ease-out;
            margin-bottom: 8px;
            line-height: 1.4;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            display: block;
            clear: both;
            font-size: inherit;
            /* –®—Ä–∏—Ñ—Ç —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω, –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript */
            font-family: inherit;
            /* –®—Ä–∏—Ñ—Ç —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω, –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript */
        }

        .chat-message.fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        .message-content {
            display: block;
            /* –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ç–µ–∫–∞–µ—Ç –±–µ–π–¥–∂–∏ –∏ –∏–º—è */
            word-break: break-word;
            /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
            overflow-wrap: break-word;
            /* –ü–µ—Ä–µ–Ω–æ—Å —Å–ª–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
            margin-top: 4px;
            /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
            clear: both;
            /* –¢–µ–∫—Å—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ–¥ –∏–º–µ–Ω–µ–º –∏ –±–µ–π–¥–∂–∞–º–∏ */
        }

        .username {
            float: left;
            /* –ò–º—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è –≤–ª–µ–≤–æ —Ä—è–¥–æ–º —Å –±–µ–π–¥–∂–∞–º–∏ */
            font-weight: 600;
            display: inline-block;
            /* –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ */
            white-space: nowrap;
            /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –∏–º–µ–Ω–∏ */
            vertical-align: middle;
            /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ */
            margin-right: 8px;
            /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∏–º–µ–Ω–µ–º –∏ —Ç–µ–∫—Å—Ç–æ–º */
            color: var(--default-name-color);
        }

        .chat-message .username {
            font-weight: 600;
            display: inline;
            white-space: nowrap;
            margin-right: 4px;
            color: var(--default-name-color);
        }

        .message-content {
            display: block;
            /* –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ç–µ–∫–∞–µ—Ç –±–µ–π–¥–∂–∏ –∏ –∏–º—è */
            word-break: break-word;
            /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
            overflow-wrap: break-word;
            /* –ü–µ—Ä–µ–Ω–æ—Å —Å–ª–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
            margin-top: 4px;
            /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
            clear: both;
            /* –¢–µ–∫—Å—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ–¥ –∏–º–µ–Ω–µ–º –∏ –±–µ–π–¥–∂–∞–º–∏ */
        }

        .chat-message .message-content {
            display: inline;
            /* –¢–µ–∫—Å—Ç –∏–¥–µ—Ç —Å—Ä–∞–∑—É –∑–∞ –∏–º–µ–Ω–µ–º */
            word-break: break-word;
        }

        .username::after {
            content: ': ';
            white-space: pre;
        }

        .message-wrapper {
            display: inline-flex;
            flex-wrap: wrap;
            min-width: 0;
            max-width: 100%;
            word-wrap: break-word;
        }

        .message {
            display: inline;
            word-break: break-word;
            white-space: pre-wrap;
            max-width: 100%;
            overflow-wrap: break-word;
        }

        .emote {
            height: var(--emote-size);
            width: auto;
            max-width: calc(var(--emote-size) * 1.5);
            vertical-align: middle;
            object-fit: contain;
            display: inline-block;
            margin: 0 2px;
            transition: opacity 0.2s ease-in-out;
        }

        .badges-container {
            float: left;
            /* –ë–µ–π–¥–∂–∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è –≤–ª–µ–≤–æ */
            display: inline-block;
            /* –ë–µ–π–¥–∂–∏ –Ω–∞ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ */
            vertical-align: middle;
            /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
            margin-right: 4px;
            /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –±–µ–π–¥–∂–∞–º–∏ –∏ –∏–º–µ–Ω–µ–º */
        }

        .chat-badge {
            width: 18px;
            /* –†–∞–∑–º–µ—Ä –±–µ–π–¥–∂–∞ */
            height: 18px;
            display: inline-block;
            vertical-align: middle;
            /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –±–µ–π–¥–∂–µ–π */
        }

        .highlighted-message {
            background-color: rgba(255, 0, 0, 0.1);
            /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω */
            border-left: 4px solid #ff0000;
            /* –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω–∞—è –ø–æ–ª–æ—Å–∞ —Å–ª–µ–≤–∞ */
            border-right: 4px solid #ff0000;
            /* –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω–∞—è –ø–æ–ª–æ—Å–∞ —Å–ª–µ–≤–∞ */
            padding: 6px 10px;
            /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
            border-radius: 4px;
            /* –ó–∞–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ —É–≥–ª—ã */
            color: inherit;
            /* –ù–∞—Å–ª–µ–¥—É–µ–º —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
        }

        .chat-link {
            color: #00b7ff;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .chat-link:hover {
            color: #66d9ff;
            text-decoration: underline;
        }

        .chat-command {
            color: #ff9966;
            font-weight: bold;
        }

        .win11-window {
            background: var(--chat-background);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .win11-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-size);
            color: #fff;
            margin-left: 10px;
            height: 100%;
        }

        .win11-title-icon {
            width: calc(var(--font-size) * 1.2);
            height: calc(var(--font-size) * 1.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }

        .win11-title-icon svg {
            width: 100%;
            height: 100%;
        }

        .win11-titlebar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 32px;
            /* –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
            height: calc(var(--font-size) * 2);
            /* –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞ */
            background: rgba(32, 32, 32, 0.9);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            user-select: none;
            padding: 0;
        }

        .win11-controls {
            display: flex;
            height: 100%;
        }

        .win11-button {
            width: calc(var(--font-size) * 3);
            /* —à–∏—Ä–∏–Ω–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —à—Ä–∏—Ñ—Ç–∞ */
            height: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            outline: none;
            cursor: pointer;
            color: #ffffff;
            transition: background-color 0.1s;
            margin: 0;
            padding: 0;
        }

        .win11-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .win11-button svg {
            width: calc(var(--font-size) * 0.8);
            height: calc(var(--font-size) * 0.8);
        }

        .win11-button.minimize svg {
            width: 46px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .win11-button.maximize svg {
            width: 15px;
            height: 15px;
        }

        .win11-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .win11-button.close {
            background-color: #c42b1c;
        }

        .win11-button.close svg {
            width: 19px;
            height: 19px;
        }

        .clip-container {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background-color: #9146FF;
            border-radius: 4px;
            animation: clipAppear 0.3s ease-out;
        }

        .clip-link {
            color: white;
            text-decoration: none;
            font-size: 14px;
            margin-left: 6px;
        }

        .clip-link::before {
            content: "üìé";
            font-size: 18px;
            margin-right: 6px;
        }

        .first-message {
            background-color: rgba(225, 0, 255, 0.1);
            /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∂–µ–ª—Ç—ã–π —Ñ–æ–Ω */
            border-left: 4px solid #b700ff54;
            /* –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω–∞—è –ø–æ–ª–æ—Å–∞ —Å–ª–µ–≤–∞ */
            border-right: 4px solid #b700ff54;
            border-radius: 4px;
            /* –ó–∞–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ —É–≥–ª—ã */
            padding: 8px;
        }

        .channel-reward {
            background-color: rgba(0, 123, 255, 0.1);
            border-left: 4px solid #007bff;
            border-right: 4px solid #007bff;
        }

        .reply-parent-preview {
            font-size: 0.8em;
            color: #adadb8;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 165, 0, 0.1);
            border-left: 2px solid #FFA500;
            border-right: 2px solid #FFA500;
            border-radius: 4px;
        }

        .reply-arrow {
            color: #adadb8;
            font-size: 1.1em;
        }

        .reply-parent-name {
            font-weight: 600;
            margin-right: 4px;
        }

        .reply-parent-text {
            color: #adadb8;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 300px;
            opacity: 0.9;
        }
        .chat-message.reply-message {
            border-left: 2px solid #FFA500;
            border-right: 2px solid #FFA500;
            padding-left: 8px;
            padding-right: 8px;
            background: rgba(255, 165, 0, 0.05);
        }

        @keyframes firstMessageHighlight {
            0% {
                background-color: rgba(255, 255, 0, 0.5);
            }

            100% {
                background-color: transparent;
            }
        }

        @keyframes clipAppear {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes emoteAppear {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: translateX(0);
            }

            100% {
                opacity: 0;
                transform: translateX(-10px);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="chat-container"></div>
    <script>
        // –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ª–æ–≥–≥–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        class Logger {
            constructor(debugMode = false) {
                this.debugMode = debugMode;
                this.styles = {
                    debug: 'color: #7CB9E8',
                    info: 'color: #98FB98',
                    warn: 'color: #FFD700',
                    error: 'color: #FF6B6B',
                    timestamp: 'color: #C0C0C0',
                    username: 'font-weight: bold'
                };
            }

            formatTimestamp(date) {
                return date.toISOString().split('T')[1].slice(0, -1);
            }

            log(level, message) {
                const timestamp = this.formatTimestamp(new Date());
                console.log(
                    `%c[${timestamp}] %c[${level.toUpperCase()}] ${message}`,
                    this.styles.timestamp,
                    this.styles[level]
                );
            }

            debug(message) {
                if (!this.debugMode) return;
                if (typeof message === 'object') {
                    if (message.tags && message.message) {
                        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
                        const username = message.tags['display-name'] || message.username;
                        const chatMessage = message.message.trim();
                        console.log(
                            `%c[${this.formatTimestamp(new Date())}] %c[DEBUG] %c${username}: %c${chatMessage}`,
                            this.styles.timestamp,
                            this.styles.debug,
                            this.styles.username,
                            'color: white'
                        );
                        if (this.debugMode && Object.keys(message.tags).length > 0) {
                            console.groupCollapsed('Message Details');
                            console.log('Tags:', message.tags);
                            console.log('Badges:', message.badges);
                            console.groupEnd();
                        }
                    } else {
                        this.log('debug', JSON.stringify(message));
                    }
                } else {
                    this.log('debug', message);
                }
            }

            info(message) {
                if (this.debugMode) {
                    this.log('info', message);
                }
            }

            warn(message) {
                if (this.debugMode) {
                    this.log('warn', message);
                }
            }

            error(message) {
                if (this.debugMode) {
                    this.log('error', message);
                    if (message instanceof Error) {
                        console.error('Stack trace:', message.stack);
                    }
                }
            }
        }
        // –ö—ç—à —ç–º–æ—É—Ç–æ–≤
        class EmoteCache {
            constructor(logger) {
                this.emotes = new Map();
                this.logger = logger;
            }

            async fetch7TVEmotes(channelId) {
                try {
                    const response = await fetch(`https://7tv.io/v3/users/twitch/${channelId}`);
                    if (!response.ok) throw new Error(`Failed to fetch 7TV emotes: ${response.status}`);
                    const data = await response.json();
                    if (data && data.emote_set && data.emote_set.emotes) {
                        data.emote_set.emotes.forEach(emote => {
                            this.emotes.set(emote.name, `https://cdn.7tv.app/emote/${emote.id}/3x.webp`);
                        });
                    }
                } catch (error) {
                    this.logger.error('Error fetching 7TV emotes:', error);
                }
            }

            getEmoteUrl(emoteName) {
                return this.emotes.get(emoteName);
            }
        }
        const emoteCache = new EmoteCache();
        async function processMessageContent(container, text, parsedMessage, isTypewriterEffect, typewriterSpeed, userColors = new Map()) {
            // –ü–∞—Ä—Å–∏–º —ç–º–æ—É—Ç—ã –∏–∑ —Ç–µ–≥–æ–≤
            function parseEmotes(emoteTag, messageText) {
                if (!emoteTag || emoteTag === true) return [];

                const emotes = [];
                const emotesArray = emoteTag.split('/');

                for (const emote of emotesArray) {
                    const [emoteId, positions] = emote.split(':');
                    if (!positions) continue;

                    positions.split(',').forEach(position => {
                        const [start, end] = position.split('-').map(Number);
                        emotes.push({
                            id: emoteId,
                            start,
                            end,
                            name: messageText.slice(start, end + 1),
                            url: `https://static-cdn.jtvnw.net/emoticons/v2/${emoteId}/default/dark/3.0`
                        });
                    });
                }

                return emotes.sort((a, b) => a.start - b.start);
            }

            const urlRegex = /(https?:\/\/[^\s]+)/;
            const commandRegex = /^!/;
            const twitchEmotes = parseEmotes(parsedMessage.tags.emotes, text);

            if (twitchEmotes.length > 0) {
                let lastIndex = 0;

                for (const emote of twitchEmotes) {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –¥–æ —ç–º–æ—É—Ç–∞
                    if (emote.start > lastIndex) {
                        const textBefore = text.slice(lastIndex, emote.start);
                        const words = textBefore.split(/\s+/);
                        for (const word of words) {
                            await processWord(word);
                        }
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º Twitch —ç–º–æ—É—Ç
                    const emoteImg = document.createElement('img');
                    emoteImg.src = emote.url;
                    emoteImg.alt = emote.name;
                    emoteImg.className = 'emote';
                    container.appendChild(emoteImg);

                    if (isTypewriterEffect) {
                        await new Promise(resolve => setTimeout(resolve, typewriterSpeed));
                    }

                    lastIndex = emote.end + 1;
                }

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–π—Å—è —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–º–æ—É—Ç–∞
                if (lastIndex < text.length) {
                    const remainingText = text.slice(lastIndex);
                    const words = remainingText.split(/\s+/);
                    for (const word of words) {
                        await processWord(word);
                    }
                }
            } else {
                const words = text.split(/\s+/);
                for (const word of words) {
                    await processWord(word);
                }
            }

            async function processWord(word) {
                const clipRegex = /(?:https?:\/\/)?(?:clips\.twitch\.tv\/|(?:www\.)?twitch\.tv\/\w+\/clip\/)([a-zA-Z0-9-_]+)/i;
                const clipMatch = word.match(clipRegex);

                if (clipMatch) {
                    const clipContainer = document.createElement('span');
                    clipContainer.className = 'clip-container';

                    const clipLink = document.createElement('a');
                    clipLink.href = word;
                    clipLink.className = 'clip-link';
                    clipLink.target = '_blank';
                    clipLink.rel = 'noopener noreferrer';
                    clipLink.textContent = '–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π –∫–ª–∏–ø';

                    clipContainer.appendChild(clipLink);
                    container.appendChild(clipContainer);
                    container.appendChild(document.createTextNode(' '));

                    if (isTypewriterEffect) {
                        await new Promise(resolve => setTimeout(resolve, typewriterSpeed));
                    }

                    return;
                }

                // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                if (word.length === 0) return;

                if (word.startsWith('@')) {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const username = word.slice(1).toLowerCase();
                    const tagSpan = document.createElement('span');

                    if (isTypewriterEffect) {
                        for (const char of word) {
                            const charSpan = document.createElement('span');
                            charSpan.textContent = char;
                            if (userColors.has(username)) {
                                charSpan.style.color = userColors.get(username);
                                charSpan.style.fontWeight = 'bold';
                            }
                            tagSpan.appendChild(charSpan);
                            await new Promise(resolve => setTimeout(resolve, typewriterSpeed));
                        }
                        tagSpan.appendChild(document.createTextNode(' '));
                    } else {
                        tagSpan.textContent = word + ' ';
                        if (userColors.has(username)) {
                            tagSpan.style.color = userColors.get(username);
                            tagSpan.style.fontWeight = 'bold';
                        }
                    }
                    container.appendChild(tagSpan);

                } else if (urlRegex.test(word)) {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–æ–∫
                    const linkElement = document.createElement('a');
                    linkElement.href = word;
                    linkElement.className = 'chat-link';
                    linkElement.target = '_blank';
                    linkElement.rel = 'noopener noreferrer';

                    if (isTypewriterEffect) {
                        for (const char of word) {
                            const charSpan = document.createElement('span');
                            charSpan.textContent = char;
                            linkElement.appendChild(charSpan);
                            await new Promise(resolve => setTimeout(resolve, typewriterSpeed));
                        }
                    } else {
                        linkElement.textContent = word;
                    }

                    container.appendChild(linkElement);
                    container.appendChild(document.createTextNode(' '));

                } else if (commandRegex.test(word)) {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
                    const commandSpan = document.createElement('span');
                    commandSpan.className = 'chat-command';

                    if (isTypewriterEffect) {
                        for (const char of word) {
                            const charSpan = document.createElement('span');
                            charSpan.textContent = char;
                            commandSpan.appendChild(charSpan);
                            await new Promise(resolve => setTimeout(resolve, typewriterSpeed));
                        }
                    } else {
                        commandSpan.textContent = word;
                    }

                    container.appendChild(commandSpan);
                    container.appendChild(document.createTextNode(' '));

                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º 7TV —ç–º–æ—É—Ç—ã
                    const emoteUrl = emoteCache.getEmoteUrl(word);
                    if (emoteUrl) {
                        const emoteImg = document.createElement('img');
                        emoteImg.src = emoteUrl;
                        emoteImg.alt = word;
                        emoteImg.className = 'emote';
                        container.appendChild(emoteImg);
                    } else if (isTypewriterEffect) {
                        for (const char of word) {
                            container.appendChild(document.createTextNode(char));
                            await new Promise(resolve => setTimeout(resolve, typewriterSpeed));
                        }
                        container.appendChild(document.createTextNode(' '));
                    } else {
                        container.appendChild(document.createTextNode(`${word} `));
                    }
                }
            }
        }
        class TwitchChat {
            constructor(channel, channelId, isTypewriterEffect, typewriterSpeed, fontSize, fontFamily, logger, win11Style) {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–∫–Ω–æ Windows 11
                if (win11Style) {
                    document.body.innerHTML = `
                <div class="win11-window">
                    <div class="win11-titlebar">
                        <div class="win11-title">
                            <div class="win11-title-icon">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M2 2.5C2 1.67157 2.67157 1 3.5 1H12.5C13.3284 1 14 1.67157 14 2.5V10.5C14 11.3284 13.3284 12 12.5 12H10L8 15L6 12H3.5C2.67157 12 2 11.3284 2 10.5V2.5ZM3.5 2C3.22386 2 3 2.22386 3 2.5V10.5C3 10.7761 3.22386 11 3.5 11H6.5L8 13.3333L9.5 11H12.5C12.7761 11 13 10.7761 13 10.5V2.5C13 2.22386 12.7761 2 12.5 2H3.5Z" fill="white"/>
                                    <path d="M7 6.5C7 6.77614 6.77614 7 6.5 7C6.22386 7 6 6.77614 6 6.5C6 6.22386 6.22386 6 6.5 6C6.77614 6 7 6.22386 7 6.5Z" fill="white"/>
                                    <path d="M10 6.5C10 6.77614 9.77614 7 9.5 7C9.22386 7 9 6.77614 9 6.5C9 6.22386 9.22386 6 9.5 6C9.77614 6 10 6.22386 10 6.5Z" fill="white"/>
                                </svg>
                            </div>
                            <span>Twitch Chat - ${channel}</span>
                        </div>
                        <div class="win11-controls">
                            <button class="win11-button minimize">
                                <svg viewBox="0 0 32 32">
                                    <path d="M6,16 L26,16" stroke="currentColor" stroke-width="1" />
                                </svg>
                            </button>
                            <button class="win11-button maximize">
                                <svg viewBox="0 0 32 32">
                                    <rect x="8" y="8" width="16" height="16" stroke="currentColor" stroke-width="1" fill="none" />
                                </svg>
                            </button>
                            <button class="win11-button close">
                                <svg viewBox="0 0 32 32">
                                    <path d="M10,10 L22,22 M10,22 L22,10" stroke="currentColor" stroke-width="1" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="chat-container"></div>
                </div>
            `;
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                    document.querySelector('.win11-button.minimize').addEventListener('click', () => {
                        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
                    });
                    document.querySelector('.win11-button.maximize').addEventListener('click', () => {
                        document.querySelector('.win11-window').classList.toggle('maximized');
                    });
                    document.querySelector('.win11-button.close').addEventListener('click', () => {
                        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–∫—Ä—ã—Ç–∏—è
                    });
                } else {
                    document.body.innerHTML = `<div id="chat-container"></div>`;
                }

                // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                this.channel = channel.toLowerCase();
                this.channelId = channelId;
                this.isTypewriterEffect = isTypewriterEffect;
                this.typewriterSpeed = typewriterSpeed;
                this.fontSize = fontSize;
                this.fontFamily = fontFamily;
                this.logger = logger;
                this.debug = logger.debugMode;

                this.userColors = new Map();
                this.displayedUsers = new Set();

                this.badgeUrls = {
                    '1979-revolution_1': `https://static-cdn.jtvnw.net/badges/v1/7833bb6e-d20d-48ff-a58d-67fe827a4f84/3`,
                    '60-seconds_1': `https://static-cdn.jtvnw.net/badges/v1/1e7252f9-7e80-4d3d-ae42-319f030cca99/3`,
                    '60-seconds_2': `https://static-cdn.jtvnw.net/badges/v1/64513f7d-21dd-4a05-a699-d73761945cf9/3`,
                    '60-seconds_3': `https://static-cdn.jtvnw.net/badges/v1/f4306617-0f96-476f-994e-5304f81bcc6e/3`,
                    'H1Z1_1': `https://static-cdn.jtvnw.net/badges/v1/fc71386c-86cd-11e7-a55d-43f591dc0c71/3`,
                    'admin': `https://static-cdn.jtvnw.net/badges/v1/9ef7e029-4cdf-4d4d-a0d5-e2b3fb2583fe/3`,
                    'ambassador': `https://static-cdn.jtvnw.net/badges/v1/2cbc339f-34f4-488a-ae51-efdf74f4e323/3`,
                    'anomaly-2_1': `https://static-cdn.jtvnw.net/badges/v1/d1d1ad54-40a6-492b-882e-dcbdce5fa81e/3`,
                    'anomaly-warzone-earth_1': `https://static-cdn.jtvnw.net/badges/v1/858be873-fb1f-47e5-ad34-657f40d3d156/3`,
                    'anonymous-cheerer': `https://static-cdn.jtvnw.net/badges/v1/ca3db7f7-18f5-487e-a329-cd0b538ee979/3`,
                    'arcane-season-2-premiere': `https://static-cdn.jtvnw.net/badges/v1/1d833bde-edc7-4d23-b7b6-ad5a13296675/3`,
                    'artist-badge': `https://static-cdn.jtvnw.net/badges/v1/4300a897-03dc-4e83-8c0e-c332fee7057f/3`,
                    'axiom-verge_1': `https://static-cdn.jtvnw.net/badges/v1/f209b747-45ee-42f6-8baf-ea7542633d10/3`,
                    'battlechefbrigade_1': `https://static-cdn.jtvnw.net/badges/v1/24e32e67-33cd-4227-ad96-f0a7fc836107/3`,
                    'battlechefbrigade_2': `https://static-cdn.jtvnw.net/badges/v1/ef1e96e8-a0f9-40b6-87af-2977d3c004bb/3`,
                    'battlechefbrigade_3': `https://static-cdn.jtvnw.net/badges/v1/107ebb20-4fcd-449a-9931-cd3f81b84c70/3`,
                    'battlerite_1': `https://static-cdn.jtvnw.net/badges/v1/484ebda9-f7fa-4c67-b12b-c80582f3cc61/3`,
                    'bits': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/73b5c3fb-24f9-4a82-a852-2f475b59411c/3`,
                        '100': `https://static-cdn.jtvnw.net/badges/v1/09d93036-e7ce-431c-9a9e-7044297133f2/3`,
                        '1000': `https://static-cdn.jtvnw.net/badges/v1/0d85a29e-79ad-4c63-a285-3acd2c66f2ba/3`,
                        '5000': `https://static-cdn.jtvnw.net/badges/v1/57cd97fc-3e9e-4c6d-9d41-60147137234e/3`,
                        '10000': `https://static-cdn.jtvnw.net/badges/v1/68af213b-a771-4124-b6e3-9bb6d98aa732/3`,
                        '25000': `https://static-cdn.jtvnw.net/badges/v1/64ca5920-c663-4bd8-bfb1-751b4caea2dd/3`,
                        '50000': `https://static-cdn.jtvnw.net/badges/v1/62310ba7-9916-4235-9eba-40110d67f85d/3`,
                        '75000': `https://static-cdn.jtvnw.net/badges/v1/ce491fa4-b24f-4f3b-b6ff-44b080202792/3`,
                        '100000': `https://static-cdn.jtvnw.net/badges/v1/96f0540f-aa63-49e1-a8b3-259ece3bd098/3`,
                        '200000': `https://static-cdn.jtvnw.net/badges/v1/4a0b90c4-e4ef-407f-84fe-36b14aebdbb6/3`,
                        '300000': `https://static-cdn.jtvnw.net/badges/v1/ac13372d-2e94-41d1-ae11-ecd677f69bb6/3`,
                        '400000': `https://static-cdn.jtvnw.net/badges/v1/a8f393af-76e6-4aa2-9dd0-7dcc1c34f036/3`,
                        '500000': `https://static-cdn.jtvnw.net/badges/v1/f6932b57-6a6e-4062-a770-dfbd9f4302e5/3`,
                        '600000': `https://static-cdn.jtvnw.net/badges/v1/4d908059-f91c-4aef-9acb-634434f4c32e/3`,
                        '700000': `https://static-cdn.jtvnw.net/badges/v1/a1d2a824-f216-4b9f-9642-3de8ed370957/3`,
                        '800000': `https://static-cdn.jtvnw.net/badges/v1/5ec2ee3e-5633-4c2a-8e77-77473fe409e6/3`,
                        '900000': `https://static-cdn.jtvnw.net/badges/v1/088c58c6-7c38-45ba-8f73-63ef24189b84/3`,
                        '1000000': `https://static-cdn.jtvnw.net/badges/v1/494d1c8e-c3b2-4d88-8528-baff57c9bd3f/3`,
                        '1250000': `https://static-cdn.jtvnw.net/badges/v1/ce217209-4615-4bf8-81e3-57d06b8b9dc7/3`,
                        '1500000': `https://static-cdn.jtvnw.net/badges/v1/c4eba5b4-17a7-40a1-a668-bc1972c1e24d/3`,
                        '1750000': `https://static-cdn.jtvnw.net/badges/v1/183f1fd8-aaf4-450c-a413-e53f839f0f82/3`,
                        '2000000': `https://static-cdn.jtvnw.net/badges/v1/7ea89c53-1a3b-45f9-9223-d97ae19089f2/3`,
                        '2500000': `https://static-cdn.jtvnw.net/badges/v1/cf061daf-d571-4811-bcc2-c55c8792bc8f/3`,
                        '3000000': `https://static-cdn.jtvnw.net/badges/v1/5671797f-5e9f-478c-a2b5-eb086c8928cf/3`,
                        '3500000': `https://static-cdn.jtvnw.net/badges/v1/c3d218f5-1e45-419d-9c11-033a1ae54d3a/3`,
                        '4000000': `https://static-cdn.jtvnw.net/badges/v1/79fe642a-87f3-40b1-892e-a341747b6e08/3`,
                        '4500000': `https://static-cdn.jtvnw.net/badges/v1/736d4156-ac67-4256-a224-3e6e915436db/3`,
                        '5000000': `https://static-cdn.jtvnw.net/badges/v1/3f085f85-8d15-4a03-a829-17fca7bf1bc2/3`,
                    },
                    'bits-charity': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/a539dc18-ae19-49b0-98c4-8391a594332b/3`,
                    },
                    'bits-leader': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/8bedf8c3-7a6d-4df2-b62f-791b96a5dd31/3`,
                        '2': `https://static-cdn.jtvnw.net/badges/v1/f04baac7-9141-4456-a0e7-6301bcc34138/3`,
                        '3': `https://static-cdn.jtvnw.net/badges/v1/f1d2aab6-b647-47af-965b-84909cf303aa/3`,
                    },
                    'brawlhalla_1': `https://static-cdn.jtvnw.net/badges/v1/bf6d6579-ab02-4f0a-9f64-a51c37040858/3`,
                    'broadcaster': `https://static-cdn.jtvnw.net/badges/v1/5527c58c-fb7d-422d-b71b-f309dcb85cc1/3`,
                    'broken-age_1': `https://static-cdn.jtvnw.net/badges/v1/56885ed2-9a09-4c8e-8131-3eb9ec15af94/3`,
                    'bubsy-the-woolies_1': `https://static-cdn.jtvnw.net/badges/v1/c8129382-1f4e-4d15-a8d2-48bdddba9b81/3`,
                    'chatter-cs-go-2022': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/57b6bd6b-a1b5-4204-9e6c-eb8ed5831603/3`,
                    },
                    'clip-champ': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/f38976e0-ffc9-11e7-86d6-7f98b26a9d79/3`,
                    },
                    'clip-the-halls': `https://static-cdn.jtvnw.net/badges/v1/ce9e266a-f490-4fb2-9989-aee20036bfa5/3`,
                    'creator-cs-go-2022': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/a2ea6df9-ac0a-4956-bfe9-e931f50b94fa/3`,
                    },
                    'cuphead_1': `https://static-cdn.jtvnw.net/badges/v1/4384659a-a2e3-11e7-a564-87f6b1288bab/3`,
                    'darkest-dungeon_1': `https://static-cdn.jtvnw.net/badges/v1/52a98ddd-cc79-46a8-9fe3-30f8c719bc2d/3`,
                    'deceit_1': `https://static-cdn.jtvnw.net/badges/v1/b14fef48-4ff9-4063-abf6-579489234fe9/3`,
                    'destiny-2-final-shape-raid-race': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/e79ee64f-31f1-4485-9c81-b93957e69f8a/3`,
                    },
                    'destiny-2-the-final-shape-streamer': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/b1bcaf3c-d7a2-442b-b407-03f2b8ff624d/3`,
                    },
                    'devil-may-cry-hd_1': `https://static-cdn.jtvnw.net/badges/v1/633877d4-a91c-4c36-b75b-803f82b1352f/3`,
                    'devil-may-cry-hd_2': `https://static-cdn.jtvnw.net/badges/v1/408548fe-aa74-4d53-b5e9-960103d9b865/3`,
                    'devil-may-cry-hd_3': `https://static-cdn.jtvnw.net/badges/v1/df84c5bf-8d66-48e2-b9fb-c014cc9b3945/3`,
                    'devil-may-cry-hd_4': `https://static-cdn.jtvnw.net/badges/v1/af836b94-8ffd-4c0a-b7d8-a92fad5e3015/3`,
                    'devilian_1': `https://static-cdn.jtvnw.net/badges/v1/3cb92b57-1eef-451c-ac23-4d748128b2c5/3`,
                    'dreamcon-2024': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/5dfbd056-8ac1-407f-bdf3-f83183fa97ae/3`,
                    },
                    'duelyst_1': `https://static-cdn.jtvnw.net/badges/v1/7d9c12f4-a2ac-4e88-8026-d1a330468282/3`,
                    'duelyst_2': `https://static-cdn.jtvnw.net/badges/v1/1938acd3-2d18-471d-b1af-44f2047c033c/3`,
                    'duelyst_3': `https://static-cdn.jtvnw.net/badges/v1/344c07fc-1632-47c6-9785-e62562a6b760/3`,
                    'duelyst_4': `https://static-cdn.jtvnw.net/badges/v1/39e717a8-00bc-49cc-b6d4-3ea91ee1be25/3`,
                    'duelyst_5': `https://static-cdn.jtvnw.net/badges/v1/290419b6-484a-47da-ad14-a99d6581f758/3`,
                    'duelyst_6': `https://static-cdn.jtvnw.net/badges/v1/c5e54a4b-0bf1-463a-874a-38524579aed0/3`,
                    'duelyst_7': `https://static-cdn.jtvnw.net/badges/v1/cf508179-3183-4987-97e0-56ca44babb9f/3`,
                    'enter-the-gungeon_1': `https://static-cdn.jtvnw.net/badges/v1/53c9af0b-84f6-4f9d-8c80-4bc51321a37d/3`,
                    'eso_1': `https://static-cdn.jtvnw.net/badges/v1/18647a68-a35f-48d7-bf97-ae5deb6b277d/3`,
                    'extension': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/ea8b0f8c-aa27-11e8-ba0c-1370ffff3854/3`,
                    },
                    'firewatch_1': `https://static-cdn.jtvnw.net/badges/v1/b6bf4889-4902-49e2-9658-c0132e71c9c4/3`,
                    'founder': `https://static-cdn.jtvnw.net/badges/v1/511b78a9-ab37-472f-9569-457753bbe7d3/3`,
                    'frozen-cortext_1': `https://static-cdn.jtvnw.net/badges/v1/2015f087-01b5-4a01-a2bb-ecb4d6be5240/3`,
                    'frozen-synapse_1': `https://static-cdn.jtvnw.net/badges/v1/d4bd464d-55ea-4238-a11d-744f034e2375/3`,
                    'game-developer': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/85856a4a-eb7d-4e26-a43e-d204a977ade4/3`,
                    },
                    'getting-over-it_1': `https://static-cdn.jtvnw.net/badges/v1/8d4e178c-81ec-4c71-af68-745b40733984/3`,
                    'getting-over-it_2': `https://static-cdn.jtvnw.net/badges/v1/bb620b42-e0e1-4373-928e-d4a732f99ccb/3`,
                    'glhf-pledge': `https://static-cdn.jtvnw.net/badges/v1/3158e758-3cb4-43c5-94b3-7639810451c5/3`,
                    'glitchcon2020': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/1d4b03b9-51ea-42c9-8f29-698e3c85be3d/3`,
                    },
                    'global_mod': `https://static-cdn.jtvnw.net/badges/v1/9384c43e-4ce7-4e94-b2a1-b93656896eba/3`,
                    'gold-pixel-heart': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/1687873b-cf38-412c-aad3-f9a4ce17f8b6/3`,
                    },
                    'gold-pixel-heart---together-for-good-24': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/52c90eac-b7ec-4e24-b500-8fceecfe91e8/3`,
                    },
                    'heavy-bullets_1': `https://static-cdn.jtvnw.net/badges/v1/fc83b76b-f8b2-4519-9f61-6faf84eef4cd/3`,
                    'hello_neighbor_1': `https://static-cdn.jtvnw.net/badges/v1/030cab2c-5d14-11e7-8d91-43a5a4306286/3`,
                    'hype-train': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/fae4086c-3190-44d4-83c8-8ef0cbe1a515/3`,
                        '2': `https://static-cdn.jtvnw.net/badges/v1/9c8d038a-3a29-45ea-96d4-5031fb1a7a81/3`,
                    },
                    'innerspace_1': `https://static-cdn.jtvnw.net/badges/v1/97532ccd-6a07-42b5-aecf-3458b6b3ebea/3`,
                    'innerspace_2': `https://static-cdn.jtvnw.net/badges/v1/fc7d6018-657a-40e4-9246-0acdc85886d1/3`,
                    'jackbox-party-pack_1': `https://static-cdn.jtvnw.net/badges/v1/0f964fc1-f439-485f-a3c0-905294ee70e8/3`,
                    'kingdom-new-lands_1': `https://static-cdn.jtvnw.net/badges/v1/e3c2a67e-ef80-4fe3-ae41-b933cd11788a/3`,
                    'la-velada-iv': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/655dac77-0b2f-4b62-8871-6ae21f82b34e/3`,
                    },
                    'minecraft-15th-anniversary-celebration': `https://static-cdn.jtvnw.net/badges/v1/178077b2-8b86-4f8d-927c-66ed6c1b025f/3`,
                    'moderator': `https://static-cdn.jtvnw.net/badges/v1/3267646d-33f0-4b17-b3df-f923a41db1d0/3`,
                    'moments': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/bf370830-d79a-497b-81c6-a365b2b60dda/3`,
                        '2': `https://static-cdn.jtvnw.net/badges/v1/fc46b10c-5b45-43fd-81ad-d5cb0de6d2f4/3`,
                        '3': `https://static-cdn.jtvnw.net/badges/v1/d08658d7-205f-4f75-ad44-8c6e0acd8ef6/3`,
                        '4': `https://static-cdn.jtvnw.net/badges/v1/fe5b5ddc-93e7-4aaf-9b3e-799cd41808b1/3`,
                        '5': `https://static-cdn.jtvnw.net/badges/v1/c8a0d95a-856e-4097-9fc0-7765300a4f58/3`,
                        '6': `https://static-cdn.jtvnw.net/badges/v1/f9e3b4e4-200e-4045-bd71-3a6b480c23ae/3`,
                        '7': `https://static-cdn.jtvnw.net/badges/v1/a90a26a4-fdf7-4ac3-a782-76a413da16c1/3`,
                        '8': `https://static-cdn.jtvnw.net/badges/v1/f22286cd-6aa3-42ce-b3fb-10f5d18c4aa0/3`,
                        '9': `https://static-cdn.jtvnw.net/badges/v1/5cb2e584-1efd-469b-ab1d-4d1b59a944e7/3`,
                        '10': `https://static-cdn.jtvnw.net/badges/v1/9c13f2b6-69cd-4537-91b4-4a8bd8b6b1fd/3`,
                        '11': `https://static-cdn.jtvnw.net/badges/v1/7573e7a2-0f1f-4508-b833-d822567a1e03/3`,
                        '12': `https://static-cdn.jtvnw.net/badges/v1/f2c91d14-85c8-434b-a6c0-6d7930091150/3`,
                        '13': `https://static-cdn.jtvnw.net/badges/v1/35eb3395-a1d3-4170-969a-86402ecfb11a/3`,
                        '14': `https://static-cdn.jtvnw.net/badges/v1/cb40eb03-1015-45ba-8793-51c66a24a3d5/3`,
                        '15': `https://static-cdn.jtvnw.net/badges/v1/b241d667-280b-4183-96ae-2d0053631186/3`,
                        '16': `https://static-cdn.jtvnw.net/badges/v1/5684d1bc-8132-4a4f-850c-18d3c5bd04f3/3`,
                        '17': `https://static-cdn.jtvnw.net/badges/v1/3b08c1ee-0f77-451b-9226-b5b22d7f023c/3`,
                        '18': `https://static-cdn.jtvnw.net/badges/v1/14057e75-080c-42da-a412-6232c6f33b68/3`,
                        '19': `https://static-cdn.jtvnw.net/badges/v1/6100cc6f-6b4b-4a3d-a55b-a5b34edb5ea1/3`,
                        '20': `https://static-cdn.jtvnw.net/badges/v1/43399796-e74c-4741-a975-56202f0af30e/3`,
                    },
                    'no_audio': `https://static-cdn.jtvnw.net/badges/v1/aef2cd08-f29b-45a1-8c12-d44d7fd5e6f0/3`,
                    'no_video': `https://static-cdn.jtvnw.net/badges/v1/199a0dba-58f3-494e-a7fc-1fa0a1001fb8/3`,
                    'okhlos_1': `https://static-cdn.jtvnw.net/badges/v1/dc088bd6-8965-4907-a1a2-c0ba83874a7d/3`,
                    'overwatch-league-insider': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/51e9e0aa-12e3-48ce-b961-421af0787dad/3`,
                    },
                    'overwatch-league-insider_2018B': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/34ec1979-d9bb-4706-ad15-464de814a79d/3`,
                    },
                    'overwatch-league-insider_2019A': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/ca980da1-3639-48a6-95a3-a03b002eb0e5/3`,
                        '2': `https://static-cdn.jtvnw.net/badges/v1/ab7fa7a7-c2d9-403f-9f33-215b29b43ce4/3`,
                    },
                    'overwatch-league-insider_2019B': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/c5860811-d714-4413-9433-d6b1c9fc803c/3`,
                        '2': `https://static-cdn.jtvnw.net/badges/v1/75f05d4b-3042-415c-8b0b-e87620a24daf/3`,
                        '3': `https://static-cdn.jtvnw.net/badges/v1/765a0dcf-2a94-43ff-9b9c-ef6c209b90cd/3`,
                        '4': `https://static-cdn.jtvnw.net/badges/v1/a8ae0ccd-783d-460d-93ee-57c485c558a6/3`,
                        '5': `https://static-cdn.jtvnw.net/badges/v1/be87fd6d-1560-4e33-9ba4-2401b58d901f/3`,
                    },
                    'partner': `https://static-cdn.jtvnw.net/badges/v1/d12a2e27-16f6-41d0-ab77-b780518f00a3/3`,
                    'power-rangers': {
                        '0': `https://static-cdn.jtvnw.net/badges/v1/9edf3e7f-62e4-40f5-86ab-7a646b10f1f0/3`,
                        '1': `https://static-cdn.jtvnw.net/badges/v1/1eeae8fe-5bc6-44ed-9c88-fb84d5e0df52/3`,
                        '2': `https://static-cdn.jtvnw.net/badges/v1/21bbcd6d-1751-4d28-a0c3-0b72453dd823/3`,
                        '3': `https://static-cdn.jtvnw.net/badges/v1/5c58cb40-9028-4d16-af67-5bc0c18b745e/3`,
                        '4': `https://static-cdn.jtvnw.net/badges/v1/8843d2de-049f-47d5-9794-b6517903db61/3`,
                        '5': `https://static-cdn.jtvnw.net/badges/v1/06c85e34-477e-4939-9537-fd9978976042/3`,
                        '6': `https://static-cdn.jtvnw.net/badges/v1/d6dca630-1ca4-48de-94e7-55ed0a24d8d1/3`,
                    },
                    'predictions': {
                        'blue-1': `https://static-cdn.jtvnw.net/badges/v1/e33d8b46-f63b-4e67-996d-4a7dcec0ad33/3`,
                        'blue-10': `https://static-cdn.jtvnw.net/badges/v1/072ae906-ecf7-44f1-ac69-a5b2261d8892/3`,
                        'blue-2': `https://static-cdn.jtvnw.net/badges/v1/ffdda3fe-8012-4db3-981e-7a131402b057/3`,
                        'blue-3': `https://static-cdn.jtvnw.net/badges/v1/f2ab9a19-8ef7-4f9f-bd5d-9cf4e603f845/3`,
                        'blue-4': `https://static-cdn.jtvnw.net/badges/v1/df95317d-9568-46de-a421-a8520edb9349/3`,
                        'blue-5': `https://static-cdn.jtvnw.net/badges/v1/88758be8-de09-479b-9383-e3bb6d9e6f06/3`,
                        'blue-6': `https://static-cdn.jtvnw.net/badges/v1/46b1537e-d8b0-4c0d-8fba-a652e57b9df0/3`,
                        'blue-7': `https://static-cdn.jtvnw.net/badges/v1/07cd34b2-c6a1-45f5-8d8a-131e3c8b2279/3`,
                        'blue-8': `https://static-cdn.jtvnw.net/badges/v1/4416dfd7-db97-44a0-98e7-40b4e250615e/3`,
                        'blue-9': `https://static-cdn.jtvnw.net/badges/v1/fc74bd90-2b74-4f56-8e42-04d405e10fae/3`,
                        'gray-1': `https://static-cdn.jtvnw.net/badges/v1/144f77a2-e324-4a6b-9c17-9304fa193a27/3`,
                        'gray-2': `https://static-cdn.jtvnw.net/badges/v1/097a4b14-b458-47eb-91b6-fe74d3dbb3f5/3`,
                        'pink-1': `https://static-cdn.jtvnw.net/badges/v1/75e27613-caf7-4585-98f1-cb7363a69a4a/3`,
                        'pink-2': `https://static-cdn.jtvnw.net/badges/v1/4b76d5f2-91cc-4400-adf2-908a1e6cfd1e/3`,
                    },
                    'premium': `https://static-cdn.jtvnw.net/badges/v1/bbbe0db0-a598-423e-86d0-f9fb98ca1933/3`,
                    'psychonauts_1': `https://static-cdn.jtvnw.net/badges/v1/a9811799-dce3-475f-8feb-3745ad12b7ea/3`,
                    'purple-pixel-heart---together-for-good-24': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/1afb4b76-8c34-4b7b-8beb-75f7e5d2a1ab/3`,
                    },
                    'raging-wolf-helm': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/3ff668be-59a3-4e3e-96af-e6b2908b3171/3`,
                    },
                    'raiden-v-directors-cut_1': `https://static-cdn.jtvnw.net/badges/v1/441b50ae-a2e3-11e7-8a3e-6bff0c840878/3`,
                    'rift_1': `https://static-cdn.jtvnw.net/badges/v1/f939686b-2892-46a4-9f0d-5f582578173e/3`,
                    'rplace-2023': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/e33e0c67-c380-4241-828a-099c46e51c66/3`,
                    },
                    'ruby-pixel-heart---together-for-good-24': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/ca0aa8ce-b2a8-4582-a5de-4d5b6915dc47/3`,
                    },
                    'samusoffer_beta': {
                        '0': `https://static-cdn.jtvnw.net/badges/v1/aa960159-a7b8-417e-83c1-035e4bc2deb5/3`,
                    },
                    'staff': `https://static-cdn.jtvnw.net/badges/v1/d97c37bd-a6f5-4c38-8f57-4e4bef88af34/3`,
                    'starbound_1': `https://static-cdn.jtvnw.net/badges/v1/e838e742-0025-4646-9772-18a87ba99358/3`,
                    'strafe_1': `https://static-cdn.jtvnw.net/badges/v1/0051508d-2d42-4e4b-a328-c86b04510ca4/3`,
                    'streamer-awards-2024': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/efc07d3d-46e4-4738-827b-a5bf3508983a/3`,
                    },
                    'sub-gift-leader': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/21656088-7da2-4467-acd2-55220e1f45ad/3`,
                        '2': `https://static-cdn.jtvnw.net/badges/v1/0d9fe96b-97b7-4215-b5f3-5328ebad271c/3`,
                        '3': `https://static-cdn.jtvnw.net/badges/v1/4c6e4497-eed9-4dd3-ac64-e0599d0a63e5/3`,
                    },
                    'sub-gifter': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/a5ef6c17-2e5b-4d8f-9b80-2779fd722414/3`,
                        '5': `https://static-cdn.jtvnw.net/badges/v1/ee113e59-c839-4472-969a-1e16d20f3962/3`,
                        '10': `https://static-cdn.jtvnw.net/badges/v1/d333288c-65d7-4c7b-b691-cdd7b3484bf8/3`,
                        '25': `https://static-cdn.jtvnw.net/badges/v1/052a5d41-f1cc-455c-bc7b-fe841ffaf17f/3`,
                        '50': `https://static-cdn.jtvnw.net/badges/v1/c4a29737-e8a5-4420-917a-314a447f083e/3`,
                        '100': `https://static-cdn.jtvnw.net/badges/v1/8343ada7-3451-434e-91c4-e82bdcf54460/3`,
                        '150': `https://static-cdn.jtvnw.net/badges/v1/514845ba-0fc3-4771-bce1-14d57e91e621/3`,
                        '200': `https://static-cdn.jtvnw.net/badges/v1/c6b1893e-8059-4024-b93c-39c84b601732/3`,
                        '250': `https://static-cdn.jtvnw.net/badges/v1/cd479dc0-4a15-407d-891f-9fd2740bddda/3`,
                        '300': `https://static-cdn.jtvnw.net/badges/v1/9e1bb24f-d238-4078-871a-ac401b76ecf2/3`,
                        '350': `https://static-cdn.jtvnw.net/badges/v1/6c4783cd-0aba-4e75-a7a4-f48a70b665b0/3`,
                        '400': `https://static-cdn.jtvnw.net/badges/v1/6f4cab6b-def9-4d99-ad06-90b0013b28c8/3`,
                        '450': `https://static-cdn.jtvnw.net/badges/v1/b593d68a-f8fb-4516-a09a-18cce955402c/3`,
                        '500': `https://static-cdn.jtvnw.net/badges/v1/60e9504c-8c3d-489f-8a74-314fb195ad8d/3`,
                        '550': `https://static-cdn.jtvnw.net/badges/v1/024d2563-1794-43ed-b8dc-33df3efae900/3`,
                        '600': `https://static-cdn.jtvnw.net/badges/v1/3ecc3aab-09bf-4823-905e-3a4647171fc1/3`,
                        '650': `https://static-cdn.jtvnw.net/badges/v1/eeabf43c-8e4c-448d-9790-4c2172c57944/3`,
                        '700': `https://static-cdn.jtvnw.net/badges/v1/4a9acdc7-30be-4dd1-9898-fc9e42b3d304/3`,
                        '750': `https://static-cdn.jtvnw.net/badges/v1/ca17277c-53e5-422b-8bb4-7c5dcdb0ac67/3`,
                        '800': `https://static-cdn.jtvnw.net/badges/v1/9c1fb96d-0579-43d7-ba94-94672eaef63a/3`,
                        '850': `https://static-cdn.jtvnw.net/badges/v1/cc924aaf-dfd4-4f3f-822a-f5a87eb24069/3`,
                        '900': `https://static-cdn.jtvnw.net/badges/v1/193d86f6-83e1-428c-9638-d6ca9e408166/3`,
                        '950': `https://static-cdn.jtvnw.net/badges/v1/7ce130bd-6f55-40cc-9231-e2a4cb712962/3`,
                        '1000': `https://static-cdn.jtvnw.net/badges/v1/bfb7399a-c632-42f7-8d5f-154610dede81/3`,
                        '2000': `https://static-cdn.jtvnw.net/badges/v1/4e8b3a32-1513-44ad-8a12-6c90232c77f9/3`,
                        '3000': `https://static-cdn.jtvnw.net/badges/v1/b18852ba-65d2-4b84-97d2-aeb6c44a0956/3`,
                        '4000': `https://static-cdn.jtvnw.net/badges/v1/efbf3c93-ecfa-4b67-8d0a-1f732fb07397/3`,
                        '5000': `https://static-cdn.jtvnw.net/badges/v1/d775275d-fd19-4914-b63a-7928a22135c3/3`,
                    },
                    'subscriber': {
                        '0': `https://static-cdn.jtvnw.net/badges/v1/5d9f2208-5dd8-11e7-8513-2ff4adfae661/3`,
                        '1': `https://static-cdn.jtvnw.net/badges/v1/5d9f2208-5dd8-11e7-8513-2ff4adfae661/3`,
                        '2': `https://static-cdn.jtvnw.net/badges/v1/25a03e36-2bb2-4625-bd37-d6d9d406238d/3`,
                        '3': `https://static-cdn.jtvnw.net/badges/v1/e8984705-d091-4e54-8241-e53b30a84b0e/3`,
                        '4': `https://static-cdn.jtvnw.net/badges/v1/2d2485f6-d19b-4daa-8393-9493b019156b/3`,
                        '5': `https://static-cdn.jtvnw.net/badges/v1/b4e6b13a-a76f-4c56-87e1-9375a7aaa610/3`,
                        '6': `https://static-cdn.jtvnw.net/badges/v1/ed51a614-2c44-4a60-80b6-62908436b43a/3`,
                    },
                    'subtember-2024': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/4149750c-9582-4515-9e22-da7d5437643b/3`,
                    },
                    'superhot_1': `https://static-cdn.jtvnw.net/badges/v1/c5a06922-83b5-40cb-885f-bcffd3cd6c68/3`,
                    'superultracombo-2023': `https://static-cdn.jtvnw.net/badges/v1/5864739a-5e58-4623-9450-a2c0555ef90b/3`,
                    'the-game-awards-2023': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/10cf46de-61e7-4a42-807a-7898408ce352/3`,
                    },
                    'the-golden-predictor-of-the-game-awards-2023': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/c84c4dd7-9318-4e8b-9f01-1612d3f83dae/3`,
                    },
                    'the-surge': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/c9f69d89-31c8-41aa-843b-fee956dfbe23/3`,
                        '2': `https://static-cdn.jtvnw.net/badges/v1/2c4d7e95-e138-4dde-a783-7956a8ecc408/3`,
                        '3': `https://static-cdn.jtvnw.net/badges/v1/0a8fc2d4-3125-4ccb-88db-e970dfbee189/3`,
                    },
                    'this-war-of-mine_1': `https://static-cdn.jtvnw.net/badges/v1/6a20f814-cb2c-414e-89cc-f8dd483e1785/3`,
                    'titan-souls': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/092a7ce2-709c-434f-8df4-a6b075ef867d/3`,
                        '2': `https://static-cdn.jtvnw.net/badges/v1/ed14caa7-665c-4b46-85ad-d65b06c71e57/3`,
                    },
                    'treasure-adventure-world_1': `https://static-cdn.jtvnw.net/badges/v1/59810027-2988-4b0d-b88d-fc414c751305/3`,
                    'turbo': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/bd444ec6-8f34-4bf9-91f4-af1e3428d80f/3`,
                    },
                    'twitch-dj': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/cf91bbc0-0332-413a-a7f3-e36bac08b624/3`,
                    },
                    'twitch-intern-2023': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/e239e7e0-e373-4fdf-b95e-3469aec28485/3`,
                    },
                    'twitch-intern-2024': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/ae96ce48-e764-4232-aa48-d9abf9a5fdab/3`,
                    },
                    'twitch-recap-2023': `https://static-cdn.jtvnw.net/badges/v1/4d9e9812-ba9b-48a6-8690-13f3f338ee65/3`,
                    'twitch-recap-2024': `https://static-cdn.jtvnw.net/badges/v1/72f2a6ac-3d9b-4406-b9e9-998b27182f61/3`,
                    'twitchbot': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/df9095f6-a8a0-4cc2-bb33-d908c0adffb8/3`,
                    },
                    'twitchcon-2024---rotterdam': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/95b10c66-775c-4652-9b86-10bd3a709422/3`,
                    },
                    'twitchcon-2024---san-diego': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/6575f0d1-2dc2-4f45-a13f-a1a969dcf8fa/3`,
                    },
                    'twitchcon2017': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/0964bed0-5c31-11e7-a90b-0739918f1d9b/3`,
                    },
                    'twitchcon2018': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/e68164e4-087d-4f62-81da-d3557efae3cb/3`,
                    },
                    'twitchconAmsterdam2020': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/ed917c9a-1a45-4340-9c64-ca8be4348c51/3`,
                    },
                    'twitchconEU2019': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/590eee9e-f04d-474c-90e7-b304d9e74b32/3`,
                    },
                    'twitchconEU2022': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/e4744003-50b7-4eb8-9b47-a7b1616a30c6/3`,
                    },
                    'twitchconEU2023': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/a8f2084e-46b9-4bb9-ae5e-00d594aafc64/3`,
                    },
                    'twitchconNA2019': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/569c829d-c216-4f56-a191-3db257ed657c/3`,
                    },
                    'twitchconNA2020': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/ed917c9a-1a45-4340-9c64-ca8be4348c51/3`,
                    },
                    'twitchconNA2022': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/344d429a-0b34-48e5-a84c-14a1b5772a3a/3`,
                    },
                    'twitchconNA2023': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/c90a753f-ab20-41bc-9c42-ede062485d2c/3`,
                    },
                    'tyranny_1': `https://static-cdn.jtvnw.net/badges/v1/0c79afdf-28ce-4b0b-9e25-4f221c30bfde/3`,
                    'user-anniversary': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/ccbbedaa-f4db-4d0b-9c2a-375de7ad947c/3`,
                    },
                    'vga-champ-2017': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/03dca92e-dc69-11e7-ac5b-9f942d292dc7/3`,
                    },
                    'vip': `https://static-cdn.jtvnw.net/badges/v1/b817aba4-fad8-49e2-b88a-7cc744dfa6ec/3`,
                    'warcraft': {
                        'alliance': `https://static-cdn.jtvnw.net/badges/v1/c4816339-bad4-4645-ae69-d1ab2076a6b0/3`,
                        'horde': `https://static-cdn.jtvnw.net/badges/v1/de8b26b6-fd28-4e6c-bc89-3d597343800d/3`,
                    },
                    'zevent-2024': {
                        '1': `https://static-cdn.jtvnw.net/badges/v1/2040d479-b815-4617-8a55-9aed027e30d0/3`,
                    },
                };

                this.messageStats = {
                    lastCleanup: Date.now(),
                    messagesPerSecond: 0,
                    lastMessageCount: 0,
                    performanceHistory: []
                };

                this.cleanupConfig = {
                    minMessagesBeforeCleanup: 10,
                    maxMessagesBeforeForceCleanup: 35,
                    cleanupInterval: 1000,
                    performanceThreshold: 30,
                    messageRetentionTime: 15000,
                    batchSize: 5,
                    cleanupDelay: 50
                };

                this.isCleanupInProgress = false;
                this.lastScrollPosition = 0;
                this.isUserScrolling = false;
                this.scrollTimeout = null;

                this.setupScrollHandlers();
                this.startPerformanceMonitoring();
                this.startAdaptiveCleanup();
                this.applyStyles();
                this.connect();
            }
            startPerformanceMonitoring() {
                let lastTime = performance.now();
                let frames = 0;

                const measurePerformance = () => {
                    const currentTime = performance.now();
                    frames++;

                    if (currentTime - lastTime >= 1000) {
                        const fps = frames * (1000 / (currentTime - lastTime));
                        this.messageStats.performanceHistory.push(fps);

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∏–∑–º–µ—Ä–µ–Ω–∏–π
                        if (this.messageStats.performanceHistory.length > 10) {
                            this.messageStats.performanceHistory.shift();
                        }

                        frames = 0;
                        lastTime = currentTime;
                    }

                    requestAnimationFrame(measurePerformance);
                };

                requestAnimationFrame(measurePerformance);
            }

            getAveragePerformance() {
                if (this.messageStats.performanceHistory.length === 0) return 60;
                return this.messageStats.performanceHistory.reduce((a, b) => a + b, 0) /
                    this.messageStats.performanceHistory.length;
            }

            startAdaptiveCleanup() {
                setInterval(() => {
                    this.adaptiveCleanup();
                }, this.cleanupConfig.cleanupInterval);
            }
            setupScrollHandlers() {
                const chatContainer = document.getElementById('chat-container');

                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –Ω–∞—á–∞–ª–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                chatContainer.addEventListener('mousewheel', () => {
                    this.isUserScrolling = true;
                    if (this.scrollTimeout) {
                        clearTimeout(this.scrollTimeout);
                    }
                    this.scrollTimeout = setTimeout(() => {
                        this.isUserScrolling = false;
                    }, 150);
                }, { passive: true });

                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                chatContainer.addEventListener('scroll', () => {
                    if (!this.isCleanupInProgress) {
                        this.lastScrollPosition = chatContainer.scrollTop;
                    }
                }, { passive: true });
            }
            async smoothCleanup(messages, criteria) {
                if (this.isCleanupInProgress) return;

                const chatContainer = document.getElementById('chat-container');
                const wasAtBottom = this.isScrolledToBottom(chatContainer);
                const initialScrollTop = chatContainer.scrollTop;

                this.isCleanupInProgress = true;
                const messagesToRemove = [];

                // –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                Array.from(messages).forEach(message => {
                    if (criteria(message)) {
                        messagesToRemove.push(message);
                    }
                });

                // –†–∞–∑–±–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞ –±–∞—Ç—á–∏
                for (let i = 0; i < messagesToRemove.length; i += this.cleanupConfig.batchSize) {
                    const batch = messagesToRemove.slice(i, i + this.cleanupConfig.batchSize);

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã—Å–æ—Ç—É –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
                    const heightBefore = chatContainer.scrollHeight;

                    // –£–¥–∞–ª—è–µ–º –±–∞—Ç—á —Å–æ–æ–±—â–µ–Ω–∏–π
                    batch.forEach(message => {
                        const height = message.offsetHeight;
                        message.style.height = '0';
                        message.style.margin = '0';
                        message.style.padding = '0';
                        message.style.opacity = '0';
                        message.style.transition = 'all 0.2s ease-out';

                        setTimeout(() => {
                            message.remove();
                        }, 200);
                    });

                    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                    const heightAfter = chatContainer.scrollHeight;
                    const heightDiff = heightBefore - heightAfter;

                    if (!wasAtBottom && !this.isUserScrolling) {
                        chatContainer.scrollTop = Math.max(0, initialScrollTop - heightDiff);
                    } else if (wasAtBottom) {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }

                    // –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –±–∞—Ç—á–µ–º
                    await new Promise(resolve => setTimeout(resolve, this.cleanupConfig.cleanupDelay));
                }

                this.isCleanupInProgress = false;
            }
            async adaptiveCleanup() {
                const chatContainer = document.getElementById('chat-container');
                const messages = chatContainer.getElementsByClassName('chat-message');
                const currentTime = Date.now();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∏
                const needsCleanup = this.shouldCleanup(messages.length);

                if (needsCleanup) {
                    const containerRect = chatContainer.getBoundingClientRect();
                    const visibleTop = containerRect.top;
                    const visibleBottom = containerRect.bottom;

                    await this.smoothCleanup(messages, (message) => {
                        const messageRect = message.getBoundingClientRect();
                        const messageTime = parseInt(message.dataset.timestamp || '0');

                        return (messageRect.bottom < visibleTop - 200) || // –í—ã—à–µ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
                            (messageRect.top > visibleBottom + 200) || // –ù–∏–∂–µ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
                            (currentTime - messageTime > this.cleanupConfig.messageRetentionTime); // –°—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    });
                }
            }
            applyStyles() {
                document.documentElement.style.setProperty('--font-size', this.fontSize);
                document.documentElement.style.setProperty('--font-family', this.fontFamily);
                const chatContainer = document.getElementById('chat-container');
                chatContainer.style.fontSize = this.fontSize;
                chatContainer.style.fontFamily = this.fontFamily;
                logger.debug(`Applying styles: fontSize=${this.fontSize}, fontFamily=${this.fontFamily}`);
            }
            async connect() {
                logger.info(`Connecting to Twitch chat for channel: ${this.channel}`);

                this.ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

                this.ws.onopen = () => {
                    this.ws.send('CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership');
                    this.ws.send('PASS SCHMOOPIIE');
                    this.ws.send('NICK justinfan12345');
                    this.ws.send(`JOIN #${this.channel}`);
                };
                this.ws.onmessage = async (event) => {
                    const parsedMessage = this.parseMessage(event.data);
                    if (parsedMessage) {
                        this.displayMessage(parsedMessage);
                    }
                };
                this.ws.onclose = () => {
                    logger.warn('Connection lost, attempting to reconnect...');
                    setTimeout(() => {
                        this.connect();
                    }, 1000);
                };

                this.ws.onerror = (error) => {
                    logger.error('WebSocket error:', error);
                    this.ws.close();
                };
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–º–æ—É—Ç—ã –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ WebSocket
                try {
                    await emoteCache.fetch7TVEmotes(this.channelId);
                    logger.info('7TV emotes loaded successfully');
                } catch (error) {
                    logger.error('Failed to load 7TV emotes:', error);
                }

            }
            parseEmotes(emoteTag, message) {
                if (!emoteTag || emoteTag === true) return [];

                const emotes = [];
                const emotesArray = emoteTag.split('/');

                for (const emote of emotesArray) {
                    const [emoteId, positions] = emote.split(':');
                    if (!positions) continue;

                    positions.split(',').forEach(position => {
                        const [start, end] = position.split('-').map(Number);
                        emotes.push({
                            id: emoteId,
                            start: start,
                            end: end,
                            name: message.slice(start, end + 1),
                            url: `https://static-cdn.jtvnw.net/emoticons/v2/${emoteId}/default/dark/1.0`
                        });
                    });
                }

                return emotes.sort((a, b) => a.start - b.start);
            }
            parseMessage(rawMessage) {
                if (!rawMessage.includes('PRIVMSG')) return null;

                const parsedMessage = {
                    tags: {},
                    username: '',
                    message: '',
                    badges: []
                };

                if (rawMessage.startsWith('@')) {
                    const tagsEnd = rawMessage.indexOf(' ');
                    const tagsStr = rawMessage.slice(1, tagsEnd);
                    const tagPairs = tagsStr.split(';');

                    for (const tagPair of tagPairs) {
                        const [key, value] = tagPair.split('=');
                        if (key === 'badges' && value && value !== 'true') {
                            parsedMessage.badges = value.split(',');
                        }
                        parsedMessage.tags[key] = value || true;
                    }

                    rawMessage = rawMessage.slice(tagsEnd + 1);
                }

                const usernameMatch = rawMessage.match(/:([^!]+)/);
                const messageParts = rawMessage.split(' :');

                parsedMessage.username = usernameMatch ? usernameMatch[1] : '';
                parsedMessage.message = messageParts.length > 1 ? messageParts[1] : '';

                this.logger.debug(parsedMessage);
                return parsedMessage;
            }
            isScrolledToBottom(container) {
                const tolerance = 50; // –ø–∏–∫—Å–µ–ª–µ–π –æ—Ç –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã
                return container.scrollHeight - container.clientHeight <= container.scrollTop + tolerance;
            }

            shouldCleanup(messageCount) {
                return messageCount > this.cleanupConfig.minMessagesBeforeCleanup &&
                    (messageCount > this.cleanupConfig.maxMessagesBeforeForceCleanup ||
                        this.getAveragePerformance() < this.cleanupConfig.performanceThreshold ||
                        this.messageStats.messagesPerSecond > 30);
            }
            getBadgeUrl(badgeType, badgeVersion) {
                if (this.badgeUrls[badgeType]) {
                    if (typeof this.badgeUrls[badgeType] === 'object') {
                        return this.badgeUrls[badgeType][badgeVersion];
                    } else {
                        return this.badgeUrls[badgeType];
                    }
                }
                return null;
            }
            async displayMessage(parsedMessage) {
                if (parsedMessage.tags['display-name'] && parsedMessage.tags.color) {
                    this.userColors.set(
                        parsedMessage.tags['display-name'].toLowerCase(),
                        parsedMessage.tags.color
                    );
                }
                const chatContainer = document.getElementById('chat-container');
                const wasAtBottom = this.isScrolledToBottom(chatContainer);
                const messageElement = document.createElement('div');
                messageElement.className = 'chat-message';
                messageElement.id = `message-${parsedMessage.tags.id}`;
                messageElement.dataset.timestamp = Date.now().toString();

                // –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                if (parsedMessage.tags['reply-parent-msg-id']) {
                    const replyPreview = document.createElement('div');
                    replyPreview.className = 'reply-parent-preview';
                    
                    const replyArrow = document.createElement('span');
                    replyArrow.className = 'reply-arrow';
                    replyArrow.textContent = '‚Ü±';
                    
                    const parentName = document.createElement('span');
                    parentName.className = 'reply-parent-name';
                    parentName.textContent = parsedMessage.tags['reply-parent-display-name'] || 'User';
                    parentName.style.color = this.userColors.get(parsedMessage.tags['reply-parent-display-name'].toLowerCase()) || '#adadb8';
                    
                    const parentText = document.createElement('span');
                    parentText.className = 'reply-parent-text';
                    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–µ–∫—Å—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    let originalText = parsedMessage.tags['reply-parent-msg-body'] || '';
                    originalText = originalText
                        .replace(/\\s/g, ' ')  // –ó–∞–º–µ–Ω—è–µ–º \s –Ω–∞ –ø—Ä–æ–±–µ–ª
                        .replace(/\\n/g, ' ')  // –ó–∞–º–µ–Ω—è–µ–º \n –Ω–∞ –ø—Ä–æ–±–µ–ª
                        .replace(/\\r/g, ' ')  // –ó–∞–º–µ–Ω—è–µ–º \r –Ω–∞ –ø—Ä–æ–±–µ–ª
                        .replace(/\\t/g, ' ')  // –ó–∞–º–µ–Ω—è–µ–º \t –Ω–∞ –ø—Ä–æ–±–µ–ª
                        .replace(/\\['"]/g, function(match) { // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
                            return match.charAt(1);
                        })
                        .trim(); // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
                    
                    parentText.textContent = originalText;
                    
                    replyPreview.appendChild(replyArrow);
                    replyPreview.appendChild(parentName);
                    replyPreview.appendChild(parentText);
                    messageElement.appendChild(replyPreview);
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                if (parsedMessage.tags['first-msg'] === '1') {
                    messageElement.classList.add('first-message');
                }
                if (parsedMessage.tags['custom-reward-id']) {
                    messageElement.classList.add('channel-reward');
                }
                if (parsedMessage.tags['msg-id'] === 'highlighted-message') {
                    messageElement.classList.add('highlighted-message');
                }
                if (parsedMessage.tags['msg-param-viewerCount']) {
                    messageElement.classList.add('raid-message');
                    logger.info(`Raid detected with ${parsedMessage.tags['msg-param-viewerCount']} viewers`);
                }

                const normalizedChannel = this.channel.toLowerCase();
                const normalizedMessage = parsedMessage.message.toLowerCase();
                if (normalizedMessage.includes(normalizedChannel)) {
                    logger.info(`Highlighting message: "${parsedMessage.message}"`);
                    messageElement.classList.add('highlighted-message');
                }

                // –°–æ–∑–¥–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –±–µ–π–¥–∂–∏
                const badgesContainer = document.createElement('span');
                badgesContainer.className = 'badges-container';
                if (Array.isArray(parsedMessage.badges) && parsedMessage.badges.length > 0) {
                    parsedMessage.badges.forEach((badge, index) => {
                        const [badgeType, badgeVersion] = badge.split('/');
                        const badgeUrl = this.getBadgeUrl(badgeType, badgeVersion);
                        if (badgeUrl) {
                            const badgeImg = document.createElement('img');
                            badgeImg.src = badgeUrl;
                            badgeImg.alt = badgeType;
                            badgeImg.className = 'chat-badge';
                            badgesContainer.appendChild(badgeImg);

                            if (index < parsedMessage.badges.length - 1) {
                                const space = document.createTextNode(' ');
                                badgesContainer.appendChild(space);
                            }
                        }
                    });
                }

                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                const usernameElement = document.createElement('span');
                usernameElement.className = 'username';
                usernameElement.textContent = parsedMessage.tags['display-name'] || parsedMessage.username;
                usernameElement.style.color = parsedMessage.tags.color || 'var(--default-name-color)';

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';

                // –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                messageElement.appendChild(badgesContainer);
                messageElement.appendChild(usernameElement);
                messageElement.appendChild(messageContent);

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                await processMessageContent(
                    messageContent,
                    parsedMessage.message,
                    parsedMessage,
                    this.isTypewriterEffect,
                    this.typewriterSpeed,
                    this.userColors
                );

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                chatContainer.appendChild(messageElement);

                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
                if (wasAtBottom && !this.isUserScrolling) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }

                // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                if (this.messageStats.messagesPerSecond > 30) {
                    this.adaptiveCleanup();
                }
            }
        }
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const urlParams = new URLSearchParams(window.location.search);
        const channel = urlParams.get('channel') || 'your_channel_name';
        const channelId = urlParams.get('channelId') || 'your_channel_id';
        const isTypewriterEffect = urlParams.get('typewriterEffect') === 'true';
        const typewriterSpeed = parseInt(urlParams.get('typewriterSpeed'), 10) || 50;
        const fontSize = urlParams.get('fontSize') || '14px';
        const fontFamily = urlParams.get('fontFamily') || 'sans-serif';
        const win11Style = urlParams.get('win11') === 'true';
        const debugMode = urlParams.get('debug') === 'true';

        // –°–æ–∑–¥–∞–µ–º –ª–æ–≥–≥–µ—Ä
        const logger = new Logger(debugMode);

        // –°–æ–∑–¥–∞–µ–º —á–∞—Ç
        const chat = new TwitchChat(
            channel, 
            channelId, 
            isTypewriterEffect, 
            typewriterSpeed, 
            fontSize, 
            fontFamily,
            logger,
            win11Style
        );
    </script>
</body>

</html>
